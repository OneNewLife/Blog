<!DOCTYPE html> <html lang="pt-br"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> 前端和 Crypto 那些情事 &bull; Mars Blog </title> <meta name="description" content=" 不知不觉都两个月没写东西了，总感觉成长路上少了点什么，但是又说不出来，直到前天我错失了大好良机才后悔莫及，从今开始要经常鞭策自己去多总结，多深度挖掘才行，机会是不会再等人的。"> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="https://mars.js.org/the-story-of-frontend-and-crypto/"> <link rel="alternate" type="application/rss+xml" title="Mars Blog" href="https://mars.js.org/feed.xml" /> </head> <body class="single"> <main class="main"> <header class="header"> <div class="overlay"> <div style="padding: 0 1em;"> <h1 class="title"> <a href="/">Mars Blog</a> </h1> <nav class="navbar"> <a href="#" class="menu-icon"> <span></span> <span></span> <span></span> </a> <ul class="nav"> <li><a href="/">Home</a></li> <li><a href="/archive.html">Archive</a></li> </ul> </nav> </div> </div> </header> <article class="post container card"> <header class="post-header"> <h1 class="post-title">前端和 Crypto 那些情事</h1> <span class="post-meta"> <time class="post-date" datetime="2016-07-15">Jul 15, 2016</time> <span class="post-author">by Mars Wong</span> </span> </header> <div class="post-content"> <blockquote> <p>不知不觉都两个月没写东西了，总感觉成长路上少了点什么，但是又说不出来，直到前天我错失了大好良机才后悔莫及，从今开始要经常鞭策自己去多总结，多深度挖掘才行，机会是不会再等人的。</p> </blockquote> <p>向来很少关注前端安全，最近学习到 Node 的 Crypto 模块，于是趁此良机好好挖掘一番。</p> <p>如果经过一番资料收集的话，你会发现 Crypto 已经不知不觉地加入了 Web API 的大家庭，真是润物细无声啊。至于 <code class="highlighter-rouge">window.crypto</code> 和 <code class="highlighter-rouge">global.crypto</code> 这对双胞胎谁是老大谁是老幺已经不重要了，反正现在都是前端的菜，我们只关注她们俩和前端的情事嘿嘿。</p> <h3 id="windowcryptoweb-crypto-api">window.crypto（Web Crypto API）</h3> <p>这货看起来身材平平，浑身上下貌似没有多少可挖掘的地方，不过却内涵十足，细细品味后别有一番滋味在心头。</p> <p>首先要注意的是 <code class="highlighter-rouge">Web Crypto API</code> 依然是一个实验性的 API，也就是说这也算得上是最前瞻的 Web 技术了，玩转 Crypto，你就是一个前端弄潮儿嘿嘿。</p> <p><code class="highlighter-rouge">Web Crypto API</code> 是一个让脚本使用密码学原理来构建系统的一个接口。 她的一个基础特性就是允许 Javascript 来操纵和存储上层的私钥（没有二进制位）。她允许 Javascript 访问以下原语：</p> <ul> <li><code class="highlighter-rouge">digest</code>：用来计算任意数据块的散列，以检测密钥的变化</li> <li><code class="highlighter-rouge">mac</code>：用来计算消息验证码</li> <li><code class="highlighter-rouge">sign</code> 和 <code class="highlighter-rouge">verify</code>：用来给文本进行数字签名以及验证签名</li> <li><code class="highlighter-rouge">encrypt</code> 和 <code class="highlighter-rouge">decrypt</code>：用来加密和解密文本</li> <li><code class="highlighter-rouge">import</code> 和 <code class="highlighter-rouge">export</code>：用来引入或导出密钥</li> <li><code class="highlighter-rouge">key generation</code>：用来创建经过加密的安全密钥或密钥对，而不需要使用元密码，不过要用到本地系统的可用熵（数据压缩的最小单位）</li> <li><code class="highlighter-rouge">key wrapping</code> 和 <code class="highlighter-rouge">unwrapping</code>：用来传输和接收一个来自第三方的经过另一个密钥加密的密钥 ，而不需要向 Javascript 暴露底层的二进制编码</li> <li><code class="highlighter-rouge">random</code>：用来生成声音经过加密后的伪随机数列</li> </ul> <p>然而 <code class="highlighter-rouge">Web Crypto API</code> 没有解决 Web 应用遇到的所有加密问题：</p> <ul> <li>没有减轻浏览器同源安全模型的负担，例如当密钥是由多个站点使用一个中央实体来发行的时候</li> <li>无法与专用的硬件进行交互，例如智能芯片、USB 加密狗以及其它的随机数生成器</li> </ul> <h3 id="密钥生成算法">密钥生成算法</h3> <h5 id="aes-cbc">AES-CBC</h5> <p><i>AES in Cipher Block Chaining mode</i>（密码块链接模式的 AES 算法）。至于密钥生成，它采用 <code class="highlighter-rouge">PKCS #7</code> 作为填充方法。</p> <p>使用这种方法生成的密钥只能通过 <code class="highlighter-rouge">encrypt</code>、<code class="highlighter-rouge">decrypt</code>、<code class="highlighter-rouge">wrapKey</code> 或 <code class="highlighter-rouge">unwrapKey</code> 来调用，如果使用其它方法来调用这种密钥，脚本将会抛出语法错误而终止。</p> <p>返回的密钥是一个 <code class="highlighter-rouge">CryptoKey</code>。</p> <p>描述 <code class="highlighter-rouge">AES-CBC</code> 算法的字典必须拥有以下参数：</p> <ul> <li><code class="highlighter-rouge">name</code>：一个包含 <code class="highlighter-rouge">AES-CBC</code> 的 DOM 字符串</li> <li><code class="highlighter-rouge">length</code>：一个包含密钥长度（位长）的无符整数，如果这个值不是 128、192 或者 256 的话就会抛出运行错误</li> </ul> <h5 id="aes-ctr">AES-CTR</h5> <p><i>AES in Counter mode</i>（计数器模式的 AES 算法）。</p> <p>主要内容和 <code class="highlighter-rouge">AES-CBC</code> 大致相同，只是字典参数 <code class="highlighter-rouge">name</code> 需要包含 <code class="highlighter-rouge">AES-CTR</code>。</p> <h5 id="aes-gcm">AES-GCM</h5> <p><i>AES in Galois/Counter mode</i>（伽罗瓦运算模式的 AES 算法）。</p> <p>主要内容和 <code class="highlighter-rouge">AES-CBC</code> 大致相同，只是字典参数 <code class="highlighter-rouge">name</code> 需要包含 <code class="highlighter-rouge">AES-GCM</code>。</p> <h5 id="rsa-oaep">RSA-OAEP</h5> <p>使用了一个 SHA 哈希函数和一个 <code class="highlighter-rouge">MGF1</code> 屏蔽生成函数的 <code class="highlighter-rouge">RSAES-OAEP</code> 算法。</p> <p>调用密钥的方法和 AES 系列密钥一样。</p> <p>返回的密钥是一个 <code class="highlighter-rouge">CryptoKeyPair</code>。</p> <p>描述 <code class="highlighter-rouge">RSA-OAEP</code> 算法的字典必须拥有以下参数：</p> <ul> <li><code class="highlighter-rouge">name</code>：一个包含 <code class="highlighter-rouge">RSA-OAEP</code> 的 DOM 字符串</li> <li><code class="highlighter-rouge">hash</code>：一个 <code class="highlighter-rouge">HashAlgorithmIdentifier</code>（使用到的哈希算法的识别码）</li> </ul> <h5 id="aes-kw">AES-KW</h5> <p><code class="highlighter-rouge">the key wrapping in AES algorithm</code>（密钥以 AES 标准来包装的算法）。</p> <p>与其它的 AES 系列算法不同，它生成的密钥只能通过 <code class="highlighter-rouge">wrapKey</code> 或 <code class="highlighter-rouge">unwrapKey</code> 来调用。其它内容大致相同，字典参数 <code class="highlighter-rouge">name</code> 需要包含 <code class="highlighter-rouge">AES-KW</code>。</p> <h5 id="hmac">HMAC</h5> <p><code class="highlighter-rouge">the hash-based message authentication method using SHA hash functions</code>（使用 SHA 哈希函数的基于散列的信息验证方法）。</p> <p>调用密钥的方法只能为 <code class="highlighter-rouge">sign</code> 或 <code class="highlighter-rouge">verify</code>。</p> <p>要注意虽然使用了 SHA 哈希函数，但是它返回的密钥却是一个 <code class="highlighter-rouge">CryptoKey</code>。</p> <p>描述 <code class="highlighter-rouge">HMAC</code> 算法的字典必须拥有以下参数：</p> <ul> <li><code class="highlighter-rouge">name</code>：一个包含 <code class="highlighter-rouge">HMAC</code> 的 DOM 字符串</li> <li><code class="highlighter-rouge">hash</code>：一个 <code class="highlighter-rouge">HashAlgorithmIdentifier</code>（使用到的哈希算法的识别码）</li> <li><code class="highlighter-rouge">length</code>（可选）：一个说明密钥大小的整数。如果没有提供，则使用哈希函数块的大小</li> </ul> <h5 id="rsassa-pkcs1-v1_5">RSASSA-PKCS1-v1_5</h5> <p>使用 SHA 哈希函数的 <code class="highlighter-rouge">RSASSA-PKCS1-v1_5</code> 算法。</p> <p>主要内容和 RSA 系列算法大致相同，字典参数 <code class="highlighter-rouge">name</code> 需要包含 <code class="highlighter-rouge">RSASSA-PKCS1-v1_5</code>。</p> <p>除了这些还有尚未完善的 <code class="highlighter-rouge">ECDSA</code>、<code class="highlighter-rouge">ECDH</code> 和 <code class="highlighter-rouge">DH</code> 算法。</p> <p><code class="highlighter-rouge">window.crypto</code> 花样可真多，一般人可真的吃不消，特别是一些新的花样（<code class="highlighter-rouge">CryptoKey</code>）仅有 Chrome 和 Firefox hold 得住。我们还是乖乖地去找性感温驯可调教的 <code class="highlighter-rouge">global.crypto</code> MM 吧(●ˇ∀ˇ●)</p> <h3 id="globalcrypto">global.crypto</h3> <p><code class="highlighter-rouge">global.crypto</code> 提供了封装好 <code class="highlighter-rouge">OpenSSL’s hash</code>、<code class="highlighter-rouge">HMAC</code>、<code class="highlighter-rouge">cipher</code>、<code class="highlighter-rouge">sign</code> 和 <code class="highlighter-rouge">verify</code> 的加密功能。</p> <p>把玩她是如此的 easy，先来上一点前戏：</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">pwd</span> <span class="o">=</span> <span class="s1">'tay1989'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHmac</span><span class="p">(</span><span class="s1">'sha256'</span><span class="p">,</span> <span class="nx">pwd</span><span class="p">)</span>
               <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s1">'Mars loves Tay'</span><span class="p">)</span>
               <span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hash</span><span class="p">);</span> <span class="c1">// 3d9d297c2c451676b697ae3dc5eaf2929596ef8e03e94dc668ace21c2d68a236</span>
</code></pre></div></div> <p>短短三两下的前戏，我们就用 <code class="highlighter-rouge">Hmac</code> 算法创建了一个密钥，是不是瞬间欲罢不能了，那就继续体验她的各种花式吧。</p> <h5 id="classcertificate">CLass:Certificate</h5> <p><code class="highlighter-rouge">SPKAC</code> 最初是由 <code class="highlighter-rouge">Netscape</code> 实现的一个证书签名请求机制，目前正式指定为 HTML5 keygen 元素的一部分。</p> <p>Crypto 模块提供了一个 <code class="highlighter-rouge">Certificate</code> 类来处理 <code class="highlighter-rouge">SPKAC</code> 数据。最常见的用法就是处理 HTML5 keygen 元素生成的数据。为了实现这个类，Node 在内部使用了 <a href="https://www.openssl.org/docs/man1.0.2/apps/spkac.html">OpenSSL’s SPKAC implementation</a>。</p> <h5 id="classcipher">Class:Cipher</h5> <p><code class="highlighter-rouge">Cipher</code> 的实例被用来加密数据，它可以通过两种方式来使用：</p> <ul> <li>作为一个读写流来使用，未加密的数据在流中经过加密产生加密的数据在可读的一端</li> </ul> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 将 Cipher 作为流来使用</span>
<span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">cipher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createCipher</span><span class="p">(</span><span class="s1">'aes192'</span><span class="p">,</span> <span class="s1">'tay1989'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">encrypted</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

<span class="nx">cipher</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'readable'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">cipher</span><span class="p">.</span><span class="nx">read</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="nx">encrypted</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">cipher</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">encrypted</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">cipher</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'Mars loves Tay'</span><span class="p">);</span>
<span class="nx">cipher</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span> <span class="c1">// a04be3610f210ac8f87db28489016ecb</span>
</code></pre></div></div> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 将 Cipher 作为管道流来使用</span>
<span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">cipher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createCipher</span><span class="p">(</span><span class="s1">'aes192'</span><span class="p">,</span> <span class="s1">'tay1989'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">'test.js'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="s1">'test.enc'</span><span class="p">);</span>

<span class="nx">input</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">cipher</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
</code></pre></div></div> <ul> <li>或者通过使用 <code class="highlighter-rouge">cipher.update()</code> 和 <code class="highlighter-rouge">cipher.final()</code> 方法来生成加密数据</li> </ul> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">cipher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createCipher</span><span class="p">(</span><span class="s1">'aes192'</span><span class="p">,</span> <span class="s1">'tay1989'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">encrypted</span> <span class="o">=</span> <span class="nx">cipher</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s1">'Mars loves Tay'</span><span class="p">,</span> <span class="s1">'utf8'</span><span class="p">,</span> <span class="s1">'hex'</span><span class="p">);</span>

<span class="nx">encrypted</span> <span class="o">+=</span> <span class="nx">cipher</span><span class="p">.</span><span class="kr">final</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">encrypted</span><span class="p">);</span> <span class="c1">// a04be3610f210ac8f87db28489016ecb</span>
</code></pre></div></div> <h5 id="classdecipher">Class:Decipher</h5> <p><code class="highlighter-rouge">Decipher</code> 的实例被用来解密数据，和 <code class="highlighter-rouge">Cipher</code> 一样，我们也可以通过两种方法来使用：</p> <ul> <li>通过流来使用</li> </ul> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 将 Decipher 作为流来使用</span>
<span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">encrypted</span> <span class="o">=</span> <span class="s1">'a04be3610f210ac8f87db28489016ecb'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">decipher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createDecipher</span><span class="p">(</span><span class="s1">'aes192'</span><span class="p">,</span> <span class="s1">'tay1989'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">decrypted</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

<span class="nx">decipher</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'readable'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">decipher</span><span class="p">.</span><span class="nx">read</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="nx">decrypted</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'utf8'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">decipher</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">decrypted</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">decipher</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">encrypted</span><span class="p">,</span> <span class="s1">'hex'</span><span class="p">);</span>
<span class="nx">decipher</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span> <span class="c1">// Mars loves Tay</span>
</code></pre></div></div> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">decipher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createDecipher</span><span class="p">(</span><span class="s1">'aes192'</span><span class="p">,</span> <span class="s1">'tay1989'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">'test.enc'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="s1">'test.js'</span><span class="p">);</span>

<span class="nx">input</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">decipher</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
</code></pre></div></div> <ul> <li>通过 <code class="highlighter-rouge">decipher.update()</code> 和 <code class="highlighter-rouge">decipher.final()</code> 来使用</li> </ul> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">decipher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createDecipher</span><span class="p">(</span><span class="s1">'aes192'</span><span class="p">,</span> <span class="s1">'tay1989'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">encrypted</span> <span class="o">=</span> <span class="s1">'a04be3610f210ac8f87db28489016ecb'</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">decrypted</span> <span class="o">=</span> <span class="nx">decipher</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">encrypted</span><span class="p">,</span> <span class="s1">'hex'</span><span class="p">,</span> <span class="s1">'utf8'</span><span class="p">);</span>

<span class="nx">decrypted</span> <span class="o">+=</span> <span class="nx">decipher</span><span class="p">.</span><span class="kr">final</span><span class="p">(</span><span class="s1">'utf8'</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">decrypted</span><span class="p">);</span> <span class="c1">// Mars loves Tay</span>
</code></pre></div></div> <h5 id="classdiffiehellman">Class:DiffieHellman</h5> <p><code class="highlighter-rouge">DiffieHellman</code> 类是一个用于创建 <code class="highlighter-rouge">Diffie-Hellman</code> 密钥交换的工具。</p> <p>这里不再有流了：</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'assert'</span><span class="p">);</span>

<span class="c1">// 生成 Tay 的密钥</span>
<span class="kd">const</span> <span class="nx">tay</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createDiffieHellman</span><span class="p">(</span><span class="mi">520</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">tay_key</span> <span class="o">=</span> <span class="nx">tay</span><span class="p">.</span><span class="nx">generateKeys</span><span class="p">();</span>

<span class="c1">// 生成 Mars 的密钥</span>
<span class="kd">const</span> <span class="nx">mars</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createDiffieHellman</span><span class="p">(</span><span class="nx">tay</span><span class="p">.</span><span class="nx">getPrime</span><span class="p">(),</span> <span class="nx">tay</span><span class="p">.</span><span class="nx">getGenerator</span><span class="p">());</span>
<span class="kd">const</span> <span class="nx">mars_key</span> <span class="o">=</span> <span class="nx">mars</span><span class="p">.</span><span class="nx">generateKeys</span><span class="p">();</span>

<span class="c1">// 交换密钥并生成最终的密钥</span>
<span class="kd">const</span> <span class="nx">tay_secret</span> <span class="o">=</span> <span class="nx">tay</span><span class="p">.</span><span class="nx">computeSecret</span><span class="p">(</span><span class="nx">mars_key</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">mars_secret</span> <span class="o">=</span> <span class="nx">mars</span><span class="p">.</span><span class="nx">computerSecret</span><span class="p">(</span><span class="nx">tay_key</span><span class="p">);</span>

<span class="c1">// 剧终</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">tay_secret</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">),</span> <span class="nx">mars_secret</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">));</span>
</code></pre></div></div> <h5 id="classsign">Class:Sign</h5> <p><code class="highlighter-rouge">Sign</code> 类是一个用来生成数字签名的工具，它同样可以通过两种方式来使用：</p> <ul> <li>通过流来使用</li> </ul> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">sign</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createSign</span><span class="p">(</span><span class="s1">'RSA-SHA256'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">private_key</span> <span class="o">=</span> <span class="nx">getPrivateKeySomehow</span><span class="p">();</span>

<span class="nx">sign</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'Mars loves Tay'</span><span class="p">);</span>
<span class="nx">sign</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">sign</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">private_key</span><span class="p">,</span> <span class="s1">'hex'</span><span class="p">));</span>
</code></pre></div></div> <ul> <li>通过 <code class="highlighter-rouge">sign.update()</code> 和 <code class="highlighter-rouge">sign.sign()</code> 的方法来使用</li> </ul> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">sign</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createSign</span><span class="p">(</span><span class="s1">'RSA-SHA256'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">private_key</span> <span class="o">=</span> <span class="nx">getPrivateKeySomehow</span><span class="p">();</span>

<span class="nx">sign</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s1">'Mars loves Tay'</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">sign</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">private_key</span><span class="p">,</span> <span class="s1">'hex'</span><span class="p">));</span>
</code></pre></div></div> <p>诸如这些算法还有 N 多个，都大同小异。</p> <p>前端和 Crypto 的情事就此画上句号了。或许光是看这些 API 很无趣，不过如果有心去研究当中的原理，还是可以保持新鲜感的。当中大多算法都是精品，如果再深度开发，则又是一大片世外桃源。</p> <aside class="share"> <span>Share this: </span> <a href="http://twitter.com/share?text=前端和 Crypto 那些情事&amp;url=https://mars.js.org/the-story-of-frontend-and-crypto/&amp;hashtags=web,dev,blog,soudev&amp;via=nandomoreirame" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fa fa-twitter-square"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://mars.js.org/the-story-of-frontend-and-crypto/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"> <i class="fa fa-facebook-square"></i> </a> </aside> </div> </article> <footer class="footer t-center"> <div class="container"> <div class="social-icons"> <ul class="text-left"> <li><a href="https://www.facebook.com/maaarswong" target="_blank"><i class="fa fa-facebook"></i></a></li> <li><a href="https://twitter.com/maaarswong" target="_blank"><i class="fa fa-twitter"></i></a></li> </ul> </div> <small> <a href=https://github.com/marswong target="_blank">Mars Wong</a> &copy; 2015 - 2020 All rights reserved. </small> <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"> <img alt="Creative Commons License" style="border-width: 0;margin: .5em auto;" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" /> </a> </div> </footer> </main> <script src="/js/typed.min.js"></script> <script> window.onload = function () { new Typed('#motto', { strings: ['起风了，唯有努力生存'], contentType: 'html', typeSpeed: 100, showCursor: false }); } </script> </body> </html></body></html>
